name: CI - Inventory Service (Go)

on:
    push:
        branches:
            - main
            - develop
            - "feature/**"
        paths:
            - "services/inventory-service/**"
            - ".github/workflows/inventory-service-ci.yml"
    pull_request:
        branches:
            - main
            - develop
        paths:
            - "services/inventory-service/**"
            - ".github/workflows/inventory-service-ci.yml"

env:
    GO_VERSION: "1.21"
    WORKING_DIR: ./services/inventory-service

jobs:
    # ============================================================================
    # Job 1: Build & Unit Tests
    # ============================================================================
    build-and-test:
        name: Build & Unit Tests
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./services/inventory-service

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ env.GO_VERSION }}
                  cache: true
                  cache-dependency-path: services/inventory-service/go.sum

            - name: Download dependencies
              run: go mod download

            - name: Verify dependencies
              run: go mod verify

            - name: Build application
              run: |
                  echo "ðŸ”¨ Building Inventory Service..."
                  go build -v -o bin/inventory-service cmd/api/main.go
                  echo "âœ… Build successful"

            - name: Run unit tests
              run: |
                  echo "ðŸ§ª Running unit tests..."
                  go test ./internal/... -v -race -short -coverprofile=coverage.out
                  echo "âœ… Unit tests passed"

            - name: Generate coverage report
              run: |
                  echo "ðŸ“Š Generating coverage report..."
                  go tool cover -func=coverage.out | tee coverage.txt
                  COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
                  echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
                  echo "ðŸ“ˆ Total coverage: ${COVERAGE}%"

            - name: Check coverage threshold
              run: |
                  THRESHOLD=70
                  if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
                    echo "âŒ Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
                    exit 1
                  else
                    echo "âœ… Coverage ${COVERAGE}% meets threshold ${THRESHOLD}%"
                  fi

            - name: Upload coverage artifact
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: services/inventory-service/coverage.out
                  retention-days: 7

    # ============================================================================
    # Job 2: Integration Tests (with Testcontainers)
    # ============================================================================
    integration-tests:
        name: Integration Tests
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./services/inventory-service

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ env.GO_VERSION }}
                  cache: true
                  cache-dependency-path: services/inventory-service/go.sum

            - name: Download dependencies
              run: go mod download

            - name: Run integration tests
              run: |
                  echo "ðŸ”— Running integration tests with Testcontainers..."
                  go test ./tests/integration/... -v -race -timeout 5m
                  echo "âœ… Integration tests passed"

    # ============================================================================
    # Job 3: Linting (golangci-lint)
    # ============================================================================
    lint:
        name: Linting & Code Quality
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./services/inventory-service

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ env.GO_VERSION }}
                  cache: true
                  cache-dependency-path: services/inventory-service/go.sum

            - name: Download dependencies
              run: go mod download

            - name: Run golangci-lint
              uses: golangci/golangci-lint-action@v6
              with:
                  version: latest
                  working-directory: services/inventory-service
                  args: --timeout=5m --config=.golangci.yml

            - name: Check Go formatting
              run: |
                  echo "ðŸŽ¨ Checking Go formatting..."
                  UNFORMATTED=$(gofmt -l .)
                  if [ -n "$UNFORMATTED" ]; then
                    echo "âŒ The following files need formatting:"
                    echo "$UNFORMATTED"
                    exit 1
                  else
                    echo "âœ… All files are properly formatted"
                  fi

            - name: Run go vet
              run: |
                  echo "ðŸ” Running go vet..."
                  go vet ./...
                  echo "âœ… go vet passed"

    # ============================================================================
    # Job 4: Security Scan (gosec)
    # ============================================================================
    security:
        name: Security Scan
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./services/inventory-service

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ env.GO_VERSION }}
                  cache: true
                  cache-dependency-path: services/inventory-service/go.sum

            - name: Run gosec security scanner
              uses: securego/gosec@master
              with:
                  args: "-no-fail -fmt sarif -out results.sarif ./..."

            - name: Upload SARIF file
              if: always()
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: results.sarif

    # ============================================================================
    # Job 5: Summary & Status
    # ============================================================================
    summary:
        name: CI Summary
        runs-on: ubuntu-latest
        needs: [build-and-test, integration-tests, lint, security]
        if: always()

        steps:
            - name: Check results
              run: |
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo "ðŸ“Š CI Pipeline Summary - Inventory Service"
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo ""
                  echo "Build & Tests:      ${{ needs.build-and-test.result }}"
                  echo "Integration Tests:  ${{ needs.integration-tests.result }}"
                  echo "Linting:            ${{ needs.lint.result }}"
                  echo "Security Scan:      ${{ needs.security.result }}"
                  echo ""
                  
                  if [ "${{ needs.build-and-test.result }}" == "success" ] && \
                     [ "${{ needs.integration-tests.result }}" == "success" ] && \
                     [ "${{ needs.lint.result }}" == "success" ] && \
                     [ "${{ needs.security.result }}" == "success" ]; then
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "âœ… All checks passed! Pipeline successful."
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    exit 0
                  else
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "âŒ Some checks failed. Please review."
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    exit 1
                  fi

            - name: Post summary to PR
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const summary = `
                      ## ðŸš€ Inventory Service CI Results
                      
                      | Check | Status |
                      |-------|--------|
                      | Build & Tests | ${{ needs.build-and-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
                      | Integration Tests | ${{ needs.integration-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
                      | Linting | ${{ needs.lint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
                      | Security Scan | ${{ needs.security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
                      
                      **Coverage:** \`${{ env.COVERAGE }}%\` (threshold: 70%)
                      `;
                      
                      github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: summary
                      });
