name: CI - Orders Service (NestJS)

on:
    push:
        branches:
            - main
            - develop
            - "feature/**"
        paths:
            - "services/orders-service/**"
            - ".github/workflows/orders-service-ci.yml"
    pull_request:
        branches:
            - main
            - develop
        paths:
            - "services/orders-service/**"
            - ".github/workflows/orders-service-ci.yml"

env:
    NODE_VERSION: "20"
    WORKING_DIR: ./services/orders-service

jobs:
    # ============================================================================
    # Job 1: Build & Unit Tests
    # ============================================================================
    build-and-test:
        name: Build & Unit Tests
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./services/orders-service

        services:
            postgres:
                image: postgres:16-alpine
                env:
                    POSTGRES_USER: test
                    POSTGRES_PASSWORD: test
                    POSTGRES_DB: microservices_orders_test
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

            redis:
                image: redis:7-alpine
                ports:
                    - 6379:6379
                options: >-
                    --health-cmd "redis-cli ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"
                  cache-dependency-path: services/orders-service/package-lock.json

            - name: Install dependencies
              run: npm ci

            - name: Run linting
              run: npm run lint

            - name: Build application
              run: |
                  echo "ğŸ”¨ Building Orders Service..."
                  npm run build
                  echo "âœ… Build successful"

            - name: Run unit tests
              env:
                  DATABASE_URL: postgresql://test:test@localhost:5432/microservices_orders_test
                  REDIS_HOST: localhost
                  REDIS_PORT: 6379
                  JWT_SECRET: test-secret
                  NODE_ENV: test
              run: |
                  echo "ğŸ§ª Running unit tests..."
                  npm run test:cov
                  echo "âœ… Unit tests passed"

            - name: Check coverage threshold
              run: |
                  echo "ğŸ“Š Checking coverage threshold..."
                  COVERAGE=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
                  THRESHOLD=70
                  echo "Coverage: ${COVERAGE}%"
                  if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
                    echo "âŒ Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
                    exit 1
                  else
                    echo "âœ… Coverage ${COVERAGE}% meets threshold ${THRESHOLD}%"
                  fi

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v4
              with:
                  files: ./services/orders-service/coverage/lcov.info
                  flags: orders-service
                  name: orders-service-coverage

            - name: Upload coverage artifact
              uses: actions/upload-artifact@v4
              with:
                  name: orders-coverage-report
                  path: services/orders-service/coverage/
                  retention-days: 7

    # ============================================================================
    # Job 2: E2E Tests
    # ============================================================================
    e2e-tests:
        name: E2E Tests
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./services/orders-service

        services:
            postgres:
                image: postgres:16-alpine
                env:
                    POSTGRES_USER: test
                    POSTGRES_PASSWORD: test
                    POSTGRES_DB: microservices_orders_test
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

            redis:
                image: redis:7-alpine
                ports:
                    - 6379:6379
                options: >-
                    --health-cmd "redis-cli ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"
                  cache-dependency-path: services/orders-service/package-lock.json

            - name: Install dependencies
              run: npm ci

            - name: Build application
              run: npm run build

            - name: Run E2E tests
              env:
                  DATABASE_URL: postgresql://test:test@localhost:5432/microservices_orders_test
                  REDIS_HOST: localhost
                  REDIS_PORT: 6379
                  JWT_SECRET: test-secret
                  NODE_ENV: test
              run: |
                  echo "ğŸŒ Running E2E tests..."
                  npm run test:e2e
                  echo "âœ… E2E tests passed"

    # ============================================================================
    # Job 3: Linting & Type Checking
    # ============================================================================
    lint:
        name: Linting & Type Check
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./services/orders-service

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"
                  cache-dependency-path: services/orders-service/package-lock.json

            - name: Install dependencies
              run: npm ci

            - name: Run ESLint
              run: |
                  echo "ğŸ” Running ESLint..."
                  npm run lint
                  echo "âœ… ESLint passed"

            - name: Run Prettier check
              run: |
                  echo "ğŸ¨ Checking code formatting..."
                  npm run format:check
                  echo "âœ… Prettier check passed"

            - name: TypeScript type checking
              run: |
                  echo "ğŸ“˜ Running TypeScript type check..."
                  npm run build
                  echo "âœ… Type check passed"

    # ============================================================================
    # Job 4: Security Audit
    # ============================================================================
    security:
        name: Security Audit
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./services/orders-service

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Run npm audit
              run: |
                  echo "ğŸ”’ Running npm audit..."
                  npm audit --audit-level=moderate
                  echo "âœ… Security audit passed"

    # ============================================================================
    # Job 5: Summary & Status
    # ============================================================================
    summary:
        name: CI Summary
        runs-on: ubuntu-latest
        needs: [build-and-test, e2e-tests, lint, security]
        if: always()

        steps:
            - name: Check results
              run: |
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo "ğŸ“Š CI Pipeline Summary - Orders Service"
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo ""
                  echo "Build & Tests:      ${{ needs.build-and-test.result }}"
                  echo "E2E Tests:          ${{ needs.e2e-tests.result }}"
                  echo "Linting:            ${{ needs.lint.result }}"
                  echo "Security Audit:     ${{ needs.security.result }}"
                  echo ""
                  
                  if [ "${{ needs.build-and-test.result }}" == "success" ] && \
                     [ "${{ needs.e2e-tests.result }}" == "success" ] && \
                     [ "${{ needs.lint.result }}" == "success" ] && \
                     [ "${{ needs.security.result }}" == "success" ]; then
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "âœ… All checks passed! Pipeline successful."
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    exit 0
                  else
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "âŒ Some checks failed. Please review."
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    exit 1
                  fi

            - name: Post summary to PR
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const summary = `
                      ## ğŸš€ Orders Service CI Results
                      
                      | Check | Status |
                      |-------|--------|
                      | Build & Tests | ${{ needs.build-and-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
                      | E2E Tests | ${{ needs.e2e-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
                      | Linting | ${{ needs.lint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
                      | Security Audit | ${{ needs.security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
                      `;
                      
                      github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: summary
                      });
